#!/bin/bash

# Function to show queue
show_queue() {
    mpc playlist -f '%position%. %file%' | sed 's/.*\///' | sed 's/\.[^.]*$//'
}

# Main loop
while true; do
    # Get current queue
    QUEUE=$(show_queue)

    if [ -z "$QUEUE" ]; then
        notify-send "Queue Empty" "No songs in queue"
        exit 0
    fi

    # Add management options at the top
    OPTIONS="‚ñ∂ Play Selected
üîÄ Shuffle Queue
üóëÔ∏è Clear Queue
---
$QUEUE"

    # Use tofi to select
    SELECTED=$(echo "$OPTIONS" | tofi --prompt-text "Queue Management: ")

    # Exit if nothing selected
    [ -z "$SELECTED" ] && exit 0

    # Handle special options
    case "$SELECTED" in
    "‚ñ∂ Play Selected")
        QUEUE=$(show_queue)
        PLAY_SELECTED=$(echo "$QUEUE" | tofi --prompt-text "Play: ")
        if [ -n "$PLAY_SELECTED" ]; then
            POSITION=$(echo "$PLAY_SELECTED" | grep -o '^[0-9]*')
            mpc play "$POSITION"
            exit 0
        fi
        ;;
    "üîÄ Shuffle Queue")
        mpc shuffle
        notify-send "üîÄ Shuffled" "Queue shuffled"
        ;;
    "üóëÔ∏è Clear Queue")
        mpc clear
        notify-send "üóëÔ∏è Cleared" "Queue cleared"
        exit 0
        ;;
    "---")
        continue
        ;;
    *)
        # Song selected - show action menu
        POSITION=$(echo "$SELECTED" | grep -o '^[0-9]*')
        SONG_NAME=$(echo "$SELECTED" | sed 's/^[0-9]*\. //')
        QUEUE_LENGTH=$(mpc playlist | wc -l)

        ACTION=$(echo -e "‚ñ∂ Play This Song\n‚¨Ü Move Up\n‚¨á Move Down\nüî¢ Move to Position\nüóëÔ∏è Remove from Queue\n‚Üê Back" | tofi --prompt-text "$SONG_NAME: ")

        case "$ACTION" in
        "‚ñ∂ Play This Song")
            mpc play "$POSITION"
            exit 0
            ;;
        "‚¨Ü Move Up")
            if [ "$POSITION" -gt 1 ]; then
                mpc move "$POSITION" $((POSITION - 1))
                notify-send "‚¨Ü Moved Up" "$SONG_NAME"
            else
                notify-send "‚ö†Ô∏è Already at top" "$SONG_NAME"
            fi
            ;;
        "‚¨á Move Down")
            if [ "$POSITION" -lt "$QUEUE_LENGTH" ]; then
                mpc move "$POSITION" $((POSITION + 1))
                notify-send "‚¨á Moved Down" "$SONG_NAME"
            else
                notify-send "‚ö†Ô∏è Already at bottom" "$SONG_NAME"
            fi
            ;;
        "üî¢ Move to Position")
            # Generate position list
            POSITIONS=$(seq 1 "$QUEUE_LENGTH")
            NEW_POS=$(echo "$POSITIONS" | tofi --prompt-text "Move to position (currently $POSITION/$QUEUE_LENGTH): ")

            if [ -n "$NEW_POS" ] && [ "$NEW_POS" -ge 1 ] && [ "$NEW_POS" -le "$QUEUE_LENGTH" ]; then
                mpc move "$POSITION" "$NEW_POS"
                notify-send "üî¢ Moved" "$SONG_NAME ‚Üí Position $NEW_POS"
            else
                notify-send "‚ö†Ô∏è Invalid" "Position must be 1-$QUEUE_LENGTH"
            fi
            ;;
        "üóëÔ∏è Remove from Queue")
            mpc del "$POSITION"
            notify-send "üóëÔ∏è Removed" "$SONG_NAME"
            ;;
        "‚Üê Back")
            continue
            ;;
        *)
            exit 0
            ;;
        esac
        ;;
    esac
done
